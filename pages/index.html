<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="format-detection" content="telephone=no" />
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="icon" href="img/favicon.ico" type="image/x-icon">
    <title>Chatbot</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.0/css/all.min.css" crossorigin="anonymous" />
    <link rel="stylesheet" href="css/chatbot.css">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, sans-serif;
        }
        /* Chatbot Detail Section */
        .chatbot-detail {
            padding: 3rem 1rem;
        }

        .chatbot-detail img {
            max-width: 100%;
            border-radius: 8px;
        }

        .chatbot-detail h2 {
            color: #00695c;
        }
    </style>
</head>

<body>

    <section id="detail" class="chatbot-detail">
        <div class="container">
            <div class="row align-items-center g-4">
                <div class="col-md-6">
                    <img src="img/chatbot.png" alt="Chatbot Demo">
                </div>
                <div class="col-md-6">
                    <h2><b>üôè YojanaGuide ‡§ï‡•ç‡§Ø‡§æ ‡§π‡•à?</b></h2>
                    <p>
                        YojanaGuide ‡§è‡§ï AI-‡§Ü‡§ß‡§æ‡§∞‡§ø‡§§ ‡§ö‡•à‡§ü‡§¨‡•â‡§ü ‡§π‡•à ‡§ú‡•ã ‡§Ü‡§™‡§ï‡•ã ‡§ú‡§º‡§ø‡§≤‡•á ‡§ï‡•Ä ‡§∏‡§≠‡•Ä ‡§∏‡§∞‡§ï‡§æ‡§∞‡•Ä ‡§Ø‡•ã‡§ú‡§®‡§æ‡§ì‡§Ç ‡§î‡§∞ ‡§∏‡•á‡§µ‡§æ‡§ì‡§Ç ‡§ï‡•á ‡§¨‡§æ‡§∞‡•á ‡§Æ‡•á‡§Ç ‡§∏‡§∞‡§≤ ‡§î‡§∞ ‡§§‡•á‡§ú‡§º ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä ‡§¶‡•á‡§§‡§æ ‡§π‡•à‡•§
                        ‡§Ø‡§π 24x7 ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§π‡•à ‡§î‡§∞ ‡§Ü‡§™‡§ï‡•Ä ‡§≠‡§æ‡§∑‡§æ ‡§Æ‡•á‡§Ç ‡§Ü‡§™‡§∏‡•á ‡§¨‡§æ‡§§ ‡§ï‡§∞‡§§‡§æ ‡§π‡•à‡•§
                    </p>
                    <ul>
                        <li>‡§∏‡§∞‡§ï‡§æ‡§∞‡•Ä ‡§Ø‡•ã‡§ú‡§®‡§æ‡§ì‡§Ç ‡§ï‡•Ä ‡§§‡§æ‡§ú‡§º‡§æ ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä</li>
                        <li>24x7 ‡§â‡§™‡§≤‡§¨‡•ç‡§ß‡§§‡§æ</li>
                        <li>‡§Ü‡§∏‡§æ‡§® ‡§î‡§∞ ‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤-‡§´‡•ç‡§∞‡•á‡§Ç‡§°‡§≤‡•Ä ‡§á‡§Ç‡§ü‡§∞‡§´‡•á‡§∏</li>
                    </ul>
                </div>
            </div>
        </div>
    </section>

    <!-- Floating Button -->
    <div id="chatToggle">
        {{-- <i class="fa-solid fa-comments"></i> --}}
        <svg focusable="false" preserveAspectRatio="xMidYMid meet" fill="currentColor" width="24" height="24" viewBox="0 0 32 32" aria-hidden="true"
        class="WACLauncher__svg" xmlns="http://www.w3.org/2000/svg"><path d="M22 4L22 6 26.586 6 20 12.586 21.414 14 28 7.414 28 12 30 12 30 4 22 4zM28
        16v4a1.9965 1.9965 0 01-2 2H20l-4 7 1.7358 1 3.4288-6H26a3.9992 3.9992 0 004-4V16zM4 20V8A1.9965 1.9965 0 016 6H18V4H6A3.9986 3.9986 0 002 8V20a3.9992
        3.9992 0 004 4h9V22H6A1.9965 1.9965 0 014 20z"></path></svg>
    </div>
    <!-- Floating Button -->

    <!-- Chat Window -->
    <div id="chatWindow" class="card shadow-lg" style="overflow-x: auto;y-overflow: auto;">
        <div class="card-header d-flex justify-content-between align-items-center">
            <div>
                <h6 class="m-0">üôè YojanaGuide</h6>
                <small>‡§ú‡§º‡§ø‡§≤‡•á ‡§ï‡•Ä ‡§Ø‡•ã‡§ú‡§®‡§æ‡§ì‡§Ç-‡§∏‡•á‡§µ‡§æ‡§ì‡§Ç ‡§∏‡§Ç‡§¨‡§Ç‡§ß‡•Ä ‡§Ü‡§™‡§ï‡•Ä ‡§ï‡§ø‡§∏ ‡§™‡•ç‡§∞‡§ï‡§æ‡§∞ ‡§Æ‡§¶‡§¶ ‡§ï‡§∞ ‡§∏‡§ï‡§§‡§æ ‡§π‡•Ç‡§Å?</small>
            </div>
            <i class="fa-regular fa-circle-xmark" id="closeChat" style="cursor:pointer"></i>
        </div>
        <div class="card-body chat-box" id="chatBox"></div>
        <div class="card-footer">
            <form id="chatForm" class="w-100">
                <div class="input-group">
                    <input type="text" class="form-control" maxlength="30" id="message" placeholder="Type or speak..." required>
                    <select id="languageSelect" class="form-select" style="max-width:100px;">
                        <option value="en-IN">English</option>
                        <option value="hi-IN" selected>‡§π‡§ø‡§Ç‡§¶‡•Ä</option>
                    </select>
                    <button class="btn btn-secondary" type="button" id="micBtn"><i
                            class="fa-solid fa-microphone"></i></button>
                    <button class="btn btn-primary" type="submit" id="sendBtn"><i class="fa-solid fa-paper-plane"></i></button>
                </div>
            </form>
        </div>
    </div>
    <!-- Chat Window -->

    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <script src="js/badword-filter.js"></script>
    <script>
        $(document).ready(function () {
            const chatBox = document.getElementById('chatBox');
            $('#chatToggle').on('click', function () {
                $('#chatWindow').show();
                setTimeout(() => {
                    $('#chatWindow').addClass('show');
                }, 10);
                $(this).hide();
            });

            $('#closeChat').on('click', function () {
                $('#chatWindow').removeClass('show');
                setTimeout(() => {
                    $('#chatWindow').hide();
                    $('#chatToggle').fadeIn();
                }, 300);
            });

            function sendMessage(question, parentId = null) {
                $.ajax({
                    url: '/send-message',
                    type: 'POST',
                    data: {
                        parentId: parentId,
                        message: question.replace(/[&\/\\#,+()$~%.'":*?<>{}]/g, ' '),
                        _token: '{{ csrf_token() }}'
                    },
                    success: function (resdata) {
                        if (resdata.status === 0) {
                            $('#chatBox').append(`<div class="chat-message chat-bot"><span class="text-secondary">${resdata.message}</span></div>`);
                        }
                        let first = true;
                        resdata.reply.forEach(function (q) {
                            if (first && q.heading) {
                                $('#chatBox').append(`<div class="chat-message chat-bot"><h6>${q.heading}</h6></div>`);
                                first = false;
                            }
                            let content = q.url ?
                                `<a href="${q.url}" target="_blank" class="btn btn-info btn-sm">${q.question}</a>` :
                                `<button class="btn btn-info btn-sm ques_btn" data-id="${q.question_id}" value="${q.question}">${q.question}</button>`;
                            $('#chatBox').append(`<div class="chat-message chat-bot">${content}</div>`);
                        });
                        if (resdata.searchOnWeb && resdata.status === 0) {
                            $('#chatBox').append(`<a href="${resdata.searchOnWeb}" target="_blank" class="btn btn-success btn-sm">üîç Search on Web</a>`);
                        }
                        // $('#chatBox').scrollTop($('#chatBox')[0].scrollHeight);
                        // const chatBox = document.getElementById('chatBox');
                        chatBox.scrollTo({
                            top: chatBox.scrollHeight,
                            behavior: 'smooth'
                        });
                    }
                });
            }

            $.ajax({
                url: '/load-initial-questions',
                type: 'GET',
                success: function (data) {
                    data.forEach(function (q) {
                        let content = q.url ?
                            `<a href="${q.url}" target="_blank" class="btn btn-info btn-sm">${q.question}</a>` :
                            `<button class="btn btn-info btn-sm ques_btn" data-id="${q.question_id}" value="${q.question}">${q.question}</button>`;
                        $('#chatBox').append(`<div class="chat-message chat-bot">${content}</div>`);
                    });
                    // $('#chatBox').scrollTop($('#chatBox')[0].scrollHeight);
                    // const chatBox = document.getElementById('chatBox');
                    chatBox.scrollTo({
                        top: chatBox.scrollHeight,
                        behavior: 'smooth'
                    });
                }
            });

            $(document).on('click', '.ques_btn', function () {
                let question = $(this).val();
                let parentId = $(this).data('id');
                $('#chatBox').append(`<div class="chat-message chat-user"><span class="btn btn-secondary btn-sm">${question}</span></div>`);
                sendMessage(question, parentId);
            });

            $('#chatForm').on('submit', function (e) {
                e.preventDefault();
                let userMsg = $('#message').val();
                $('#message').val('');
                let abuseWords = checkWords(userMsg.toLowerCase());
                // console.log("Abuse words check:", userMsg.toLowerCase());
                if (abuseWords.status === 1) {
                    $('#chatBox').append(`<div class="chat-message chat-bot">${abuseWords.msg}</div>`);
                }
                else {
                    $('#chatBox').append(`<div class="chat-message chat-user"><span class="btn btn-secondary btn-sm">${userMsg}</span></div>`);
                    sendMessage(userMsg);
                }
                // $('#chatBox').scrollTop($('#chatBox')[0].scrollHeight);
                // const chatBox = document.getElementById('chatBox');
                chatBox.scrollTo({
                    top: chatBox.scrollHeight,
                    behavior: 'smooth'
                });
            });
        });
    </script>
    <script>
        let recognition;
        let recognizing = false;
        if ('webkitSpeechRecognition' in window) {
            recognition = new webkitSpeechRecognition();
            // recognition.lang = 'en-IN';
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.onstart = () => {
                recognizing = true;
                $('#micBtn').text('üéôÔ∏èListening...');
            };
            recognition.onend = () => {
                recognizing = false;
                $('#micBtn').html('<i class="fa-solid fa-microphone"></i>');
                 $("#languageSelect").prop('disabled', false);
            };
            recognition.onresult = (event) => {
                $('#message').val(event.results[0][0].transcript).focus();
                $('#chatForm').submit();
            };
        }
        $('#micBtn').on('click', function () {
            $("#languageSelect").prop('disabled', true);
            let lang = $("#languageSelect").val();
            recognition.lang = lang;
            if (recognition && !recognizing) recognition.start();
            else if (recognizing) recognition.stop();
            // $("#languageSelect").prop('disabled', false);
        });

    </script>
</body>
</html>
